name: Health Checks & API Verification

# Run on every push to main/develop and on pull requests
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run health checks daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  health-check:
    name: Database & API Health Checks
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: consilience_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio httpx

      - name: Create test .env file
        run: |
          cat > .env << EOF
          DEBUG=true
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/consilience_test
          AUTH_URL=https://neon.example.com/auth
          JWKS_URL=https://neon.example.com/.well-known/jwks.json
          OPENROUTER_API_KEY=test-key
          FRONTEND_URL=http://localhost:3000
          EOF

      - name: Initialize database
        run: |
          python -c "
          import asyncio
          from database.connection import init_async_db
          
          async def init():
              try:
                  await init_async_db()
                  print('✓ Database initialized successfully')
              except Exception as e:
                  print(f'✗ Database initialization failed: {e}')
                  raise
          
          asyncio.run(init())
          "

      - name: Run health check tests
        run: |
          pytest tests/test_auth_complete.py::test_health_check -v

      - name: Test API root endpoint
        run: |
          pytest tests/test_auth_complete.py::test_root_endpoint -v

      - name: Run database connectivity tests
        run: |
          pytest tests/test_database.py -v

      - name: Run authentication tests
        run: |
          pytest tests/test_auth_complete.py -v

      - name: Start API server
        run: |
          timeout 60 uvicorn api.main:app --host 127.0.0.1 --port 8000 &
          sleep 5
          
      - name: Test API endpoints with curl
        run: |
          # Test root endpoint
          curl -f http://127.0.0.1:8000/ || exit 1
          echo "✓ Root endpoint OK"
          
          # Test health endpoint
          curl -f http://127.0.0.1:8000/health || exit 1
          echo "✓ Health endpoint OK"
          
      - name: Check API response format
        run: |
          python -c "
          import httpx
          import asyncio
          import json
          
          async def check():
              async with httpx.AsyncClient() as client:
                  # Test root endpoint
                  resp = await client.get('http://127.0.0.1:8000/')
                  assert resp.status_code == 200
                  data = resp.json()
                  assert 'service' in data
                  assert data['service'] == 'Consilience'
                  print('✓ Root endpoint format OK')
                  
                  # Test health endpoint
                  resp = await client.get('http://127.0.0.1:8000/health')
                  assert resp.status_code == 200
                  data = resp.json()
                  assert 'status' in data
                  assert 'database' in data
                  assert 'service' in data
                  print(f'✓ Health endpoint format OK (status: {data[\"status\"]}, db: {data[\"database\"]})')
          
          asyncio.run(check())
          "

  test-suite:
    name: Core Test Suite
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: consilience_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio pytest-mock pytest-cov

      - name: Create test .env file
        run: |
          cat > .env << EOF
          DEBUG=true
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/consilience_test
          AUTH_URL=https://neon.example.com/auth
          JWKS_URL=https://neon.example.com/.well-known/jwks.json
          OPENROUTER_API_KEY=test-key
          FRONTEND_URL=http://localhost:3000
          EOF

      - name: Run test suite
        run: |
          pytest tests/ -v --tb=short --cov=. --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  lint-check:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint black mypy flake8 bandit

      - name: Run Pylint
        continue-on-error: true
        run: |
          pylint api/ agents/ services/ models/ --disable=all --enable=E,F || true

      - name: Check code style with Black
        continue-on-error: true
        run: |
          black --check api/ agents/ services/ models/ || true

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy api/ agents/ services/ models/ --ignore-missing-imports || true

      - name: Security check with Bandit
        continue-on-error: true
        run: |
          bandit -r api/ agents/ services/ models/ -f json -o bandit-report.json || true

  dependency-check:
    name: Dependencies Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Check for known vulnerabilities
        run: |
          python -m pip install --upgrade pip safety
          pip install -e .
          safety check || echo "Review security issues above"

      - name: Validate requirements
        run: |
          python -m pip check

  status-check:
    name: Status Check (Required)
    runs-on: ubuntu-latest
    needs: [health-check, test-suite]
    if: always()
    
    steps:
      - name: Check health checks
        if: needs.health-check.result != 'success'
        run: |
          echo "Health checks failed!"
          exit 1
      
      - name: Check test suite
        if: needs.test-suite.result != 'success'
        run: |
          echo "Test suite failed!"
          exit 1
      
      - name: All checks passed
        run: echo "✓ All health and status checks passed"
